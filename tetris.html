<html>
  <head>
    <title>Josh Backstein - Tetris</title>
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
    </style>
  </head>
  <body>
    <div id="ThreeJS" style="position: absolute; left:0px; top:0px"></div>

    <script src="js/three.min.js"></script>
    <script src="js/constants.js"></script>
    <script src="js/cube.js"></script>
    <script src="js/boards.js"></script>
    <script src="js/blocks.js"></script>
    <script>
      "use strict";

      // Global variables.
      var scene, camera, renderer;
      var geometry, material, mesh;
      var cameraRot = Math.PI / 4;
      var board = [];

      init();
      animate();

      function init() {
        // Create the main scene for the 3D drawing
        scene = new THREE.Scene();

        // Every scene needs a camera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.y = CAMERA_Y;
        camera.position.x = Math.sin(cameraRot) * CAMERA_X;
        camera.position.z = Math.cos(cameraRot) * CAMERA_Z;
        camera.lookAt(new THREE.Vector3(0, 0, 0));

        // Add light to the scene.
        var ambientLight = new THREE.AmbientLight(0xf0f0f0);
        scene.add(ambientLight);
        // TODO: Add point lights.

        // Add sky box to the scene.
        var skyBoxGeometry = new THREE.BoxGeometry(5000, 5000, 5000);
        var skyBoxMaterial = new THREE.MeshBasicMaterial({
          color: 0x42c0fb,
          side: THREE.BackSide
        });
        var skyBoxMesh = new THREE.Mesh(skyBoxGeometry, skyBoxMaterial);
        scene.add(skyBoxMesh);

        if (ADD_FLOOR) {
          // Add floor of board to the scene.
          var floorSize = BOARD_SIZE * CUBE_SIZE;
          var floorGeometry = new THREE.PlaneBufferGeometry(floorSize, floorSize, 1, 1);
          var floorMaterial = new THREE.MeshPhongMaterial({
            color: 0x444444,
            side: THREE.DoubleSide
          });
          var floorMesh = new THREE.Mesh(floorGeometry, floorMaterial);
          scene.add(floorMesh);
          floorMesh.rotateX(Math.PI / 2);
        }

        // Initialize board, then add it to the scene. We'll use the first
        // board by default.
        //initBoard();
        //setBoard(0);

        // Add block to the scene.
        addBlock(5);

        // Add grid helper to the scene.
        if (ADD_GRID_HELPER) {
          var gridSize = BOARD_SIZE * CUBE_SIZE;
          var gridDivisions = BOARD_SIZE;
          var gridHelper = new THREE.GridHelper(gridSize, gridDivisions, 0x000000, 0x000000);
          scene.add(gridHelper);
        }

        // Add axis helper to the scene.
        if (ADD_AXIS_HELPER) {
          var axisLength = (BOARD_SIZE * CUBE_SIZE) / 2;
          var axisHelper = new THREE.AxisHelper(axisLength);
          scene.add(axisHelper);
        }

        // The renderer renders the scene using the objects, lights and camera.
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Attach the threeJS renderer to the HTML page
        document.body.appendChild(renderer.domElement);

      }

      // Add block at the provided location.
      function addBlock(blockType = 1, x = 0, y = 0, z = 0) {
        // Which block do we need?
        var block;
        switch (blockType) {
          case 1: 
            block = BLOCK_1;
            break;
          case 2: 
            block = BLOCK_2;
            break;
          case 3: 
            block = BLOCK_3;
            break;
          case 4: 
            block = BLOCK_4;
            break;
          case 5: 
            block = BLOCK_5;
            break;
          case 6: 
            block = BLOCK_6;
            break;
          case 7: 
            block = BLOCK_7;
            break;
          default:
            block = BLOCK_1;
            break;
        }

        // Start drawing the cubes for the block.
        for (var iX = 0; iX < block.grid.length; iX++) {
          for (var iY = 0; iY < block.grid[iX].length; iY++) {
            for (var iZ = 0; iZ < block.grid[iX][iY].length; iZ++) {
              if (block.grid[iX][iY][iZ] == 1) {
                addCube(x + iX, y + iY, z + iZ, block.color);
              }
            }
          }
        }
      }

      // Add cube at the provided location on the grid, where the grid starts
      // at 0.
      function addCube(x = 0, y = 0, z = 0, color = 0xffffff) {
        var cube = new Cube(x, y, z, color);
        cube.addToScene(scene);
        return cube;
      }

      // Initialize the board.
      function initBoard() {
        board = [];
        for (var y = 0; y < BOARD_HEIGHT; y++) {
          // Create layer to add to the board.
          var layer = [];

          // Add rows along z-axis to layer.
          for (var z = 0; z < BOARD_SIZE; z++) {
            // Create row to add to the layer.
            var row = [];

            // Add columns along x-axis to row.
            for (var x = 0; x < BOARD_SIZE; x++) {
              // Add empty cell.
              row.push(0);
            }

            // Add row to the layer.
            layer.push(row);
          }

          // Add layer to board.
          board.push(layer);
        }
      }

      // Clear the board of all cubes.
      function clearBoard() {
        // Board goes by layers, then rows along z-axis, then
        // columns along x-axis.
        for (var y = 0; y < board.length; y++) {
          for (var z = 0; z < board[y].length; z++) {
            for (var x = 0; x < board[y][z].length; x++) {
              board[y][z][x] = 0;
            }
          }
        }
      }

      // Set the board to use.
      function setBoard(i = 0) {
        // Make sure we're using a valid board.
        if (i < 0 || i >= boards.length) {
          // It's not a valid board, so default to the first one.
          i = 0;
        }

        // Loop through the board array and add each cube to the board.
        for (var z = 0; z < boards[i].length; z++) {
          for (var x = 0; x < boards[i][z].length; x++) {
            if (boards[i][z][x] != 0) {
              board[0][z][x] = addCube(x, 0, z, 0x888888);
              board[0][z][x].blockNumber = blockCounter;
            }
          }
        }
        blockCounter += 1;
      }

      // This is the game/animation loop
      function animate() {
        // Get an animation frame to render.
        requestAnimationFrame(animate);

        // Move the camera
        //cameraRot -= 0.005;
        camera.position.y = CAMERA_Y;
        camera.position.x = Math.sin(cameraRot) * CAMERA_X;
        // TODO: Remember to remove this when you're done.
        //camera.position.x = 0;
        camera.position.z = Math.cos(cameraRot) * CAMERA_Z;
        camera.lookAt(new THREE.Vector3(0, 0, 0));

        // Render the scene.
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
